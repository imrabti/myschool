<definitions id="definitions"
             targetNamespace="http://activiti.org/bpmn20"
             xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:activiti="http://activiti.org/bpmn">
    <process id="register" isExecutable="true" name="test">
        <startEvent id="start"/>
        <sequenceFlow sourceRef="start" targetRef="sendActivationMail"/>

        <serviceTask id="sendActivationMail" name="sendmail task" activiti:type="mail">
            <extensionElements>
                <activiti:field name="from" expression="${email.from}"/>
                <activiti:field name="to" expression="${email.to}"/>
                <activiti:field name="subject" expression="${email.subject}"/>
                <activiti:field name="html">
                    <activiti:expression>
                        <![CDATA[
                            ${email.message}
                        ]]>
                    </activiti:expression>
                </activiti:field>
            </extensionElements>
        </serviceTask>

        <sequenceFlow sourceRef="sendActivationMail" targetRef="activationTask"/>

        <userTask id="activationTask" activiti:assignee="${token}"/>
        <boundaryEvent id="timerDelete" attachedToRef="activationTask" cancelActivity="false">
            <timerEventDefinition>
                <timeDuration>PT30M</timeDuration>
            </timerEventDefinition>
        </boundaryEvent>
        <boundaryEvent id="timerRelance" attachedToRef="activationTask" cancelActivity="false" >
            <timerEventDefinition>
                <timeDuration>PT10M</timeDuration>
            </timerEventDefinition>
        </boundaryEvent>

        <sequenceFlow sourceRef="activationTask" targetRef="getActivationMail"/>

        <serviceTask id="getActivationMail"
                     activiti:expression="#{registerProcessService.getActivationMail(userId,email)}" activiti:resultVariableName="email" />

        <sequenceFlow sourceRef="getActivationMail" targetRef="sendRegistrationMail"/>

        <serviceTask id="sendRegistrationMail" name="send activation task" activiti:type="mail">
            <extensionElements>
                <activiti:field name="from" expression="${email.from}"/>
                <activiti:field name="to" expression="${email.to}"/>
                <activiti:field name="subject" expression="${email.subject}"/>
                <activiti:field name="html">
                    <activiti:expression>
                        <![CDATA[
                            ${email.message}
                        ]]>
                    </activiti:expression>
                </activiti:field>
            </extensionElements>
        </serviceTask>

        <sequenceFlow sourceRef="sendRegistrationMail" targetRef="end"/>
        <endEvent id="end"/>

        <sequenceFlow sourceRef="timerRelance" targetRef="getRelanceMail"/>
        <serviceTask id="getRelanceMail"
                     activiti:expression="#{registerProcessService.getRelanceMail(userId,token,email)}" activiti:resultVariableName="email"/>

        <sequenceFlow sourceRef="getRelanceMail" targetRef="sendRelanceTask"/>

        <serviceTask id="sendRelanceTask" name="send relance task" activiti:type="mail">
            <extensionElements>
                <activiti:field name="from" expression="${email.from}"/>
                <activiti:field name="to" expression="${email.to}"/>
                <activiti:field name="subject" expression="${email.subject}"/>
                <activiti:field name="html">
                    <activiti:expression>
                        <![CDATA[
                            ${email.message}
                        ]]>
                    </activiti:expression>
                </activiti:field>
            </extensionElements>
        </serviceTask>
        <sequenceFlow sourceRef="sendRelanceTask" targetRef="relanceEnd"/>
        <intermediateThrowEvent id="relanceEnd"/>

        <sequenceFlow sourceRef="timerDelete" targetRef="deleteTask"/>
        <serviceTask id="deleteTask" activiti:expression="#{registerProcessService.deleteAccount(userId)}"/>
        <sequenceFlow sourceRef="deleteTask" targetRef="deleteEnd"/>
        <endEvent id="deleteEnd"/>

    </process>
</definitions>